# Bug Fixes Session - Dec 11, 2024

## Issues Reported
1. **Blank results page** - queries complete but show nothing
2. **Query clears on refresh** - text disappears when page refreshes
3. **Cursor jumps to end** - can't type in middle of query

---

## Bug #1: Blank Results Page (FIXED)

**Symptoms:**
- With BYOK keys: Query submits, loading works, results page shows BLANK
- Without keys: "No keys" error, then query clears

**Possible causes:**
- SSE stream not parsed correctly
- Result object malformed
- State cleared during navigation
- `conversationHistory` reset unexpectedly

**Debug steps needed:**
1. Check browser Network tab - is `complete` event received with data?
2. Check console for errors
3. Add console.log in SSE handler to verify result structure

**Code locations to check:**
- `app/page.tsx:456-470` - SSE 'complete' event handler
- `src/components/ResultsView.tsx:155` - synthesis rendering
- `app/api/research/stream/route.ts:448` - where result is sent

---

## Bug #2: Query Clears on Refresh (FIXED)

**Root Cause:** `useBrowserHistory` hook used `window.history.pushState` which doesn't persist across refresh.

**Fix Applied:**
- `src/hooks/useBrowserHistory.ts`: Added `?q=` URL param in pushState
- `app/page.tsx`: Read `?q=` param on mount and restore query
- `app/page.tsx`: Call `pushState('research', { query: finalQuery })` when research starts

---

## Bug #3: Cursor Jumps to End (FIXED)

**Root Cause:** `useTransition` causes async state updates, losing cursor position.

**Fix Applied:**
- Removed `useTransition` from `setQuery` wrapper
- Removed `useTransition` from `setFollowUpQuery` wrapper
- Removed unused `useTransition` import

---

## Files Modified
- `src/hooks/useBrowserHistory.ts` - URL param persistence
- `app/page.tsx` - URL reading, removed useTransition
- `.env.local` - Added OPENROUTER_API_KEY

## Vercel Changes
- Added `OPENROUTER_API_KEY` to env vars
- Triggered redeploy (in progress)

---

## Status: ALL FIXED âœ…

### Summary
1. ~~Blank results~~ - OPENROUTER_API_KEY was missing from Vercel
2. ~~Query clears on refresh~~ - localStorage for drafts + URL param during research
3. ~~Cursor jumping~~ - Removed useTransition from state setters
4. ~~Back button~~ - localStorage fallback in handleNavigateBack

### Commits
- `6e86ee6` - Fix cursor jumping and query persistence on refresh
- `39d6ba0` - Change default model from DeepSeek R1 to Grok Fast
- `1f9d6f7` - Add localStorage fallback to handleNavigateBack for back button support
- `92f086e` - Add super_admin role to bypass credit checks

### Verified on test.eachie.ai
- Research completes successfully
- Results display correctly
- Query persists via localStorage (typing) and URL (during research)
- Draft restores on back button
- New defaults: Claude Haiku, Gemini 2.5 Flash, Grok Fast

---

## Additional Work: Super Admin Role

**Added:** Dec 11, 2024

### Database Changes
- Added `is_super_admin` column to `users` table
- kevin@trimm.co marked as super_admin

### Code Changes (`src/server/queries/usage.ts`)
- Updated `User` interface with `is_super_admin`
- Updated `getUserCredits()` to return `isSuperAdmin`
- Added `super_admin` to `UsageCheckResult` type
- Updated `checkUsageAllowed()` to bypass credits for super_admins
- Updated `deductUserCredits()` to track spending without deducting
- Added Slack alert function (triggers at $50 threshold)

### Behavior
- Super admins bypass all credit checks
- Spending still tracked in `total_spent_cents`
- Slack alert when spending crosses $50 (needs `SLACK_WEBHOOK_URL` env var)

### Other Changes
- Removed phone number requirement from Clerk sign-in
